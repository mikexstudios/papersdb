{% extends "papers/app_base.html" %}
{% block bodyid %}new_paper{% endblock %}

{% block title %}Add Paper{% endblock %}

{% block javascript %}
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.validate/1.7/jquery.validate.pack.js"></script> -->
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.form.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.periodicalupdater.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.url.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            //10 sec delay.
            $('#messages').delay(10000).fadeOut('slow');

            //If the user has manual add set and submitted a form with errors,
            //retain the manual view.
            if ($.url.param('manual') == 'true') {
                $('#import_url_form').hide();
                $('#import_url_description').hide();
                $('#select_manual_add').hide();
                $('#new_paper_form').show();
                $('#select_auto_add').show();
            }

            $('#select_manual_add a').click(function() {
                //Can simplify this by adding a common class to the elements
                //to be hidden.
                $('#new_paper_form').slideDown();
                $('#import_url_form').slideUp();
                $('#import_url_description').slideUp();
                $('#import_status').slideUp();
                $('#import_error').slideUp();
                $('#select_manual_add').slideUp();
                $('#select_auto_add').slideDown();
                return false;
            });

            $('#select_auto_add a').click(function() {
                $('#new_paper_form').slideUp();
                $('#import_url_form').slideDown();
                $('#import_url_description').slideDown();
                $('#select_manual_add').slideDown();
                $('#select_auto_add').slideUp();
                return false;
            });

            $('#import_url_form').ajaxForm({
                dataType: 'json',
                beforeSubmit: function(arr) {
                    //Remove any statuses
                    $('#import_status').hide();
                    $('#import_error').hide();

                    //TODO: Validate URL with JS.
                    
                    //Disable textbook and submit button.
                    

                },
                success: function(responseText, statusText) {
                    //statusText is fairly useless here since it'll always say
                    //success if we get here...
                    //alert('status: ' + statusText + '\n\nresponseText: \n' + responseText);

                    data = responseText;
                    //Check if the request was successful
                    if (data['success'] == true) {
                        //Show status/progress bar
                        $('#import_status').slideDown();

                        
                        poll_url = '{% url import_url %}' + data['id'] + '/';
                        pu = $.PeriodicalUpdater(poll_url, {
                            method: 'get',          // method; get or post
                            minTimeout: 1000,       // starting value for the timeout in milliseconds
                            maxTimeout: 10000,      // maximum length of time between requests
                            multiplier: 1.2,          // if set to 2, timerInterval will double each time the response hasn't changed (up to maxTimeout)
                            type: 'json',           // response type - text, xml, json, etc. See $.ajax config options
                            maxCalls: 50,           // maximum number of calls. 0 = no limit.
                            autoStop: 0             // automatically stop requests after this many returns of the same data. 0 = disabled.
                        }, function(data) {
                            // Handle the new data (only called when there was a change)
                            if (data['is_done'] == true) {
                                set_citation_information(data['data']);
                                //.stop() prevents anything else from executing so we put this
                                //last.
                                pu.stop();
                            } 
                            //TODO: Determine the progress of the refresh.
                        });
                    } else {
                        //Request was unsuccessful
                        //TODO: parse errors. 
                        $('#import_error').slideDown();
                    }
                }
            });

            function set_citation_information(data) {
                //Hide all auto-add stuff. Show the manual add form.
                //TODO: Make showing manual add form a function.
                $('#new_paper_form').slideDown();
                $('#import_url_form').slideUp();
                $('#import_url_description').slideUp();
                $('#import_status').slideUp();
                $('#import_error').slideUp();
                $('#select_manual_add').slideUp();
                $('#select_auto_add').slideDown();

                //Fill in form.
                $.each(data, function(key, val) {
                    $('#id_' + key).val(val);
                });


            }
        });
    </script>
{% endblock %}

{% block sitenav %}{% endblock %}

{% block subcontent %}
<h2 id="title">Add a New Paper</h2>

<div id="description"></div>

<div id="select_auto_add" class="select_link"><a href="#">&larr; Try automatically adding the citation</a></div>

<p id="import_url_description">Tell us the URL of the paper and we will try
to fill in the citation information automatically:</p>

<form action="{% url import_url %}" method="POST" name="import_url_form"
    id="import_url_form" class="papers">
    {% csrf_token %}

    <div class="field">
        <label for="id_url" class="optional">URL</label> 
        <div class="right">
            {{ import_url_form.url }}
        </div>
    </div>

    <div class="actions">
        <button type="submit" id="new_paper_submit" class="light" name="submit"
            value="Submit">Add Paper &raquo;</button>
    </div>
</form>

<div id="import_status">
    <img src="{{ MEDIA_URL }}images/loading.gif" />
    <p>Attempting to retrieve citation information...</p>
</div>

<div id="import_error">
    <p>Enter a valid URL</p>
</div>

<div id="select_manual_add" class="select_link">Or, <a href="#">I would like to add the paper manually...</a></div>

<form action="?manual=true" method="POST" enctype="multipart/form-data"
    name="new_paper_form" id="new_paper_form" class="papers">
    {% csrf_token %}
    <div class="field">
        <label for="id_title">Title</label> 
        <div class="right">
            {{ form.title.errors }}
            {{ form.title }}
        </div>
    </div>

    <div class="field">
        <label for="id_authors">Author(s)</label> 
        <div class="right">
            {{ form.authors.errors }}
            {{ form.authors }}
            <small class="helper">Enter each author on a new line. You may
            format each name like: <strong>First Middle Last</strong> or <strong>Last,
            First Middle</strong>.</small>
        </div>
    </div>

    <div class="field">
        <label for="id_journal" class="optional">Journal</label> 
        <div class="right">
            {{ form.journal.errors }}
            {{ form.journal }}
        </div>
    </div>

    <div class="field">
        <label for="id_year" class="optional">Year</label> 
        <div class="right">
            {{ form.year.errors }}
            {{ form.year }}
        </div>
    </div>

    <div class="field">
        <label for="id_volume" class="optional">Volume</label> 
        <div class="right">
            {{ form.volume.errors }}
            {{ form.volume }}
        </div>
    </div>

    <div class="field">
        <label for="id_issue" class="optional">Issue</label> 
        <div class="right">
            {{ form.issue.errors }}
            {{ form.issue }}
        </div>
    </div>

    <div class="field">
        <label for="id_pages" class="optional">Pages</label> 
        <div class="right">
            {{ form.pages.errors }}
            {{ form.pages }}
        </div>
    </div>

    <div class="field">
        <label for="id_url" class="optional">URL</label> 
        <div class="right">
            {{ form.url.errors }}
            {{ form.url }}
        </div>
    </div>

    <div class="field">
        <label for="id_file" class="optional">File</label> 
        <div class="right">
            {{ form.file.errors }}
            {{ form.file }}
            <small class="helper">Select and upload the file that is associated with this paper.</small>
        </div>
    </div>

    <div class="actions">
        <button type="submit" id="new_paper_submit" class="light" name="submit"
            value="Submit">Add paper &raquo;</button>
    </div>
</form>
{% endblock %}

